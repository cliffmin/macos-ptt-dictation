#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'

echo "==> macos-ptt-dictation: install helper"
REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"

# Check dependencies and guide user
if ! command -v ffmpeg >/dev/null 2>&1; then
  echo "WARN: ffmpeg not found. Install with: brew install ffmpeg" >&2
fi
if ! command -v whisper >/dev/null 2>&1; then
  echo "INFO: Whisper CLI not found in PATH. Install with:" >&2
  echo "  python3 -m pip install --user pipx" >&2
  echo "  python3 -m pipx ensurepath || true" >&2
  echo "  pipx install --include-deps openai-whisper" >&2
fi

# Link module
mkdir -p "$HOME/.hammerspoon"
ln -sf "$REPO_DIR/hammerspoon/push_to_talk.lua" "$HOME/.hammerspoon/push_to_talk.lua"

# Copy sample config if absent
if [[ ! -f "$HOME/.hammerspoon/ptt_config.lua" ]]; then
  if [[ -f "$REPO_DIR/hammerspoon/ptt_config.lua.sample" ]]; then
    cp "$REPO_DIR/hammerspoon/ptt_config.lua.sample" "$HOME/.hammerspoon/ptt_config.lua"
    echo "Created ~/.hammerspoon/ptt_config.lua from sample"
  fi
fi

cat <<'EON'
Next steps:
  1) Install Hammerspoon (if not installed): brew install --cask hammerspoon
  2) Reload Hammerspoon (menu bar icon â†’ Reload Config)
  3) Grant permissions: Microphone (and Accessibility for Hammerspoon)
  4) Press-and-hold F13 to record; release to transcribe and paste
EON
